# GitHub同期ガイド

bkstgはGitHubリポジトリと連携してカタログを管理します。このガイドでは同期機能の仕組みを説明します。

## 概要

bkstgの同期ワークフロー：

```
UIで編集 → 保存 → ローカルに自動コミット → Syncパネルでプッシュ/PR作成
```

## 自動コミット

### 動作

UIからエンティティやスコアカード定義を保存すると：

1. **YAMLファイルが保存される** - クローンディレクトリ内のファイルが更新される
2. **自動的にコミットされる** - `auto_commit: true`の場合（デフォルト）

### 設定

`bkstg.yaml`で自動コミットを制御：

```yaml
sources:
  - type: github
    owner: your-org
    repo: your-catalog
    branch: main
    name: my-catalog
    auto_commit: true   # デフォルト: true
```

| 設定 | 動作 |
|------|------|
| `auto_commit: true` | 保存時に自動コミット（デフォルト） |
| `auto_commit: false` | ファイル保存のみ、手動コミットが必要 |

> **注意**: 自動コミットはローカルリポジトリへのコミットのみです。リモートへのプッシュは行いません。

## ブランチ設定

### ターゲットブランチ

コミット先のブランチは`bkstg.yaml`の`branch`設定で決まります：

```yaml
sources:
  - type: github
    owner: your-org
    repo: your-catalog
    branch: main        # ← このブランチにコミットされる
    name: my-catalog
```

- **デフォルト**: `main`
- クローン時にこのブランチがチェックアウトされる
- すべてのローカルコミットはこのブランチに行われる

### 複数環境での設定

開発/本番環境で異なるブランチを使用する場合：

```yaml
# 開発環境
sources:
  - type: github
    branch: develop
    # ...

# 本番環境
sources:
  - type: github
    branch: main
    # ...
```

## Syncパネル

### 同期状態

Syncパネルには各ソースの状態が表示されます：

| 表示 | 状態 | 意味 |
|------|------|------|
| `[OK]` | SYNCED | ローカルとリモートが同期済み |
| `[>>]` | LOCAL_AHEAD | ローカルにプッシュ待ちのコミットがある |
| `[<<]` | REMOTE_AHEAD | リモートに新しい変更がある |
| `[<>]` | DIVERGED | ローカルとリモートが分岐している |
| `[!!]` | CONFLICT | コンフリクトが検出された |
| `[--]` | NOT_CLONED | まだクローンされていない |
| `[??]` | UNKNOWN | 状態を判定できない |

### アクションボタン

状態に応じて異なるボタンが表示されます：

| 状態 | 表示されるボタン |
|------|------------------|
| `[OK]` SYNCED | Sync（最新を取得） |
| `[>>]` LOCAL_AHEAD | **Push**、Create PR |
| `[<<]` REMOTE_AHEAD | Pull（ローカルに取得） |
| `[<>]` DIVERGED | Pull、**Create PR**、**Force Sync** |
| `[!!]` CONFLICT | **Force Sync** |

## Push vs Create PR

### Push（直接プッシュ）

- 設定されたブランチに**直接**変更をプッシュ
- レビューなしで即座にリモートに反映
- 小さな変更やレビューが不要な場合に使用

```
ローカルコミット → origin/mainに直接プッシュ
```

### Create PR（プルリクエスト）

- 新しいブランチを作成してPRをオープン
- PRは設定されたブランチ（例：main）をベースにする
- マージ前にレビューが可能

```
ローカルコミット → 新規ブランチ作成 → PR作成（main ← 新規ブランチ）
```

### プッシュ後の自動同期

プッシュが成功すると、bkstgは自動的にローカルクローンをリモートと同期します：

1. プッシュが正常に完了
2. ローカルクローンが自動的にリモートと一致するよう更新
3. 状態が`[OK]` SYNCEDに戻る

これにより、ローカルの状態がリモートリポジトリと常に一致します。

## 強制同期（Force Sync）

### 使用するタイミング

Force Syncは、ローカルの変更を破棄して分岐やコンフリクト状態から復旧するために使用します：

- **DIVERGED状態**: ローカルとリモートの両方に異なる変更がある場合
- **CONFLICT状態**: コンフリクトを自動的に解決できない場合
- **復旧**: リモートの状態から新しくやり直したい場合

### Force Syncの動作

1. **すべてのローカル変更を破棄** - コミット済み・未コミットのローカル変更が失われる
2. **リモートにリセット** - ローカルブランチがリモートブランチと完全に一致するようリセット
3. **必要に応じて再クローン** - 深刻な場合はリポジトリを再クローン

> **警告**: Force Syncは破壊的な操作です。すべてのローカル変更が完全に失われます。この機能を使用する前に、重要な変更はバックアップしてください。

### UI操作手順

1. **Syncパネル**を開く
2. `[<>]` DIVERGEDまたは`[!!]` CONFLICTを表示しているソースを見つける
3. **Force Sync**ボタンをクリック
4. プロンプトで操作を確認
5. 同期が完了するまで待つ

## Location（チームリポジトリ）の同期

Locationエンティティで参照されるチームリポジトリも同期できます：

- Syncパネルで`[Location]`タグ付きで表示
- Pull/Push/Create PR/Force Sync操作が利用可能
- 各チームリポジトリは独立して管理

### Location同期の機能

| 機能 | 説明 |
|------|------|
| 独立した同期 | 各Locationリポジトリは独自の同期状態を持つ |
| スパースチェックアウト | カタログファイルのみクローン（効率的） |
| 完全な編集機能 | Locationからのエンティティも完全に編集可能 |
| PRサポート | チームリポジトリへのPR作成が可能 |

## ワークフロー例

### シンプルワークフロー（直接プッシュ）

1. UIでエンティティを編集して保存
2. 変更がローカルに自動コミットされる
3. Syncパネルで「Push」ボタンをクリック
4. 変更がリモートに反映（自動同期でローカルも更新）

### レビューワークフロー（プルリクエスト）

1. UIでエンティティを編集して保存
2. 変更がローカルに自動コミットされる
3. Syncパネルで「Create PR」ボタンをクリック
4. PRのタイトルと説明を入力
5. PRが作成され、レビュー後にマージ
6. マージ後にPullでローカルを更新

### 復旧ワークフロー（Force Sync）

DIVERGED状態でローカル変更を破棄したい場合：

1. Syncパネルを開く（`[<>]` DIVERGEDが表示）
2. 「Force Sync」ボタンをクリック
3. 操作を確認
4. ローカルがリモートに一致するようリセット
5. 状態が`[OK]` SYNCEDに戻る

### 手動でのPR作成

手動でPRを作成する場合：

```bash
cd ~/.bkstg-clones/{owner}_{repo}_{branch}
git checkout -b feature/my-changes
git push -u origin feature/my-changes
gh pr create --base main --title "変更内容" --body "説明"
```

## クローンディレクトリ構造

bkstgはリポジトリを`~/.bkstg-clones/`にクローンします：

```
~/.bkstg-clones/
├── {owner}_{repo}_{branch}/           # メインカタログリポジトリ
│   └── catalogs/
│       ├── components/
│       ├── apis/
│       └── scorecards/
├── {owner}_{repo}_{branch}_loc1/      # Locationリポジトリ1
│   └── catalogs/
└── {owner}_{repo}_{branch}_loc2/      # Locationリポジトリ2
    └── catalogs/
```

### スパースチェックアウト

リポジトリはスパースチェックアウトが有効な状態でクローンされます：

- 指定されたカタログディレクトリのみチェックアウト
- ディスク使用量とクローン時間を削減
- 完全なリポジトリ履歴は引き続き利用可能

## トラブルシューティング

### 「0 commit(s) to push」と表示されるが`[>>]`状態

- コミットされていない変更がある可能性
- 「Refresh」ボタンをクリックして状態を更新

### コンフリクトが発生した

1. 「Pull」を試して最新を取得
2. 解決できない場合は「Force Sync」でリモートにリセット
3. または「Create PR」でPRを作成し、GitHub上でコンフリクトを解決

### 変更が反映されない

1. Syncパネルで「Refresh」ボタンをクリック
2. アプリ下部の「Reload」をクリックしてカタログを再読み込み

### DIVERGED状態が解決しない

Pullで分岐状態が解決しない場合：

1. 「Create PR」で変更を保存し、GitHubでマージ
2. または「Force Sync」でローカル変更を破棄し、リモートにリセット

### 認証の問題

bkstgはGitHub操作に`gh` CLIまたは`git`を使用します：

- `gh auth login`が完了していることを確認
- またはgit認証情報が設定されていることを確認
- リポジトリへの書き込みアクセス権があることを確認

---

*このガイドはbkstgの現行機能（2026年1月時点）に基づいています。*
